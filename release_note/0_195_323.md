# Release Note: v0.195.323

## 概要

トップレベルのリスト項目でShift+Tabを押すと、ネストされた子リスト（ul/ol）が全て消えるバグを修正。

---

## 課題

### 再現手順

以下のHTMLがエディタにある状態で、「a」にカーソルを置きShift+Tabを押す：

```
- a       ← カーソル位置
  - b
  - c
```

### 期待される結果

```
a         ← 段落に変換
- b       ← 独立したトップレベルリストとして残る
- c
```

### 実際の結果

```
a         ← 段落に変換
            ← b, c が消える
```

---

## 原因

### `convertListItemToParagraph()` がネストリストを破棄する

`convertListItemToParagraph()` (L10248) は `<li>` を `<p>` に変換する関数。子ノードを走査してテキストコンテンツを収集する際、`<ul>`/`<ol>` を**スキップ**していた：

```javascript
for (const child of li.childNodes) {
    if (child.nodeType === 3) {
        content += child.textContent;
    } else if (child.nodeType === 1 &&
               child.tagName.toLowerCase() !== 'input' &&
               child.tagName.toLowerCase() !== 'ul' &&    // ← スキップ
               child.tagName.toLowerCase() !== 'ol') {    // ← スキップ
        content += child.outerHTML;
    }
}
```

テキストだけ抽出して `<p>` を作成した後、`li.remove()` で `<li>` を削除する。この時、スキップしたネストリストも `<li>` の子要素なのでDOMから一緒に消える。

```
Before li.remove():
<ul>
  <li>a              ← これを remove()
    <ul>             ← li の子なので一緒に消える
      <li>b</li>
      <li>c</li>
    </ul>
  </li>
</ul>

After li.remove():
<p>a</p>             ← テキストだけ残る
```

---

## 対策

### 設計

`<li>` を削除する前に、子の `<ul>`/`<ol>` を別配列に退避し、段落挿入後にそれらを段落の後に独立したリストとして挿入する。

**修正前**:
```
<li>a<ul>...</ul></li>
  ↓ convertListItemToParagraph
<p>a</p>              ← ネストリスト消失
```

**修正後**:
```
<li>a<ul>...</ul></li>
  ↓ convertListItemToParagraph
<p>a</p>
<ul>                  ← 段落の後に独立リストとして配置
  <li>b</li>
  <li>c</li>
</ul>
```

### 実装

```javascript
// 変更前: ul/ol は単にスキップされ、収集されない
let content = '';
for (const child of li.childNodes) { ... }

// 変更後: ul/ol を別配列に収集
let content = '';
var nestedLists = [];
for (const child of li.childNodes) {
    if (child.nodeType === 3) {
        content += child.textContent;
    } else if (child.nodeType === 1) {
        var childTag = child.tagName.toLowerCase();
        if (childTag === 'ul' || childTag === 'ol') {
            nestedLists.push(child);       // ← 退避
        } else if (childTag !== 'input') {
            content += child.outerHTML;
        }
    }
}

// 段落挿入後、ネストリストを段落の後に挿入
var insertAfter = p;
for (var i = 0; i < nestedLists.length; i++) {
    if (insertAfter.nextSibling) {
        insertAfter.parentNode.insertBefore(nestedLists[i], insertAfter.nextSibling);
    } else {
        insertAfter.parentNode.appendChild(nestedLists[i]);
    }
    insertAfter = nestedLists[i];
}
```

複数のネストリスト（`<ul>` + `<ol>` が兄弟として存在するケース）にも対応。挿入順序を維持するため `insertAfter` 変数で挿入位置を追跡する。

---

## テスト

### 新規テストファイル

[shift-tab-nested-children.spec.ts](test/specs/shift-tab-nested-children.spec.ts)（5件）

| テスト | 内容 |
| --- | --- |
| ネスト子リストが独立リストとして保持される | 基本ケース: `- a / - b / - c` → `<p>a</p><ul>...` |
| 複数のネストリスト（ul+ol）が全て保持される | `<li>a<ul>...</ul><ol>...</ol></li>` で両方残る |
| リストに他の項目がある場合、それらも保持される | `- a / - b / - c / - d` で d も残る |
| 空のトップレベルリスト項目にネスト子がある場合 | `<li><br><ul>...</ul></li>` でもネストが残る |
| round-trip: Shift+Tab後のMarkdownが正しい | MD出力で `a` が段落、`- b` `- c` がリスト |

### テスト結果

| テストスイート | 結果 |
| --- | --- |
| shift-tab-nested-children (5件) | 全パス |
| 全体 (497件) | 492パス / 1失敗（既存・無関係）/ 4スキップ |

---

## 変更ファイル一覧

| ファイル | 変更内容 |
| --- | --- |
| `src/webview/editor.js` | `convertListItemToParagraph()`: ネストリスト退避・再挿入ロジック追加 |
| `test/specs/shift-tab-nested-children.spec.ts` | 新規テストファイル（5件） |
| `test/html/standalone-editor.html` | 自動再生成 |
| `package.json` | バージョン 0.195.322 → 0.195.323 |
