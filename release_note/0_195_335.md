# v0.195.335 — コードブロック・引用ブロック内の複数行選択 Tab/Shift+Tab

## 課題

コードブロック編集モードで `Shift+↑` / `Shift+↓` により複数行を範囲選択した状態で `Tab` を押すと、最初の行しかインデントされない。同様に `Shift+Tab` でのデインデントも最初の行のみ。引用ブロックでも同じ問題が発生していた。

## 原因

Tab ハンドラのフロー:
1. テーブルセルチェック → リスト項目チェック → 複数ブロック選択チェック → 単一ブロックフォールバック

コードブロック・引用ブロック内で複数行選択した場合:
- 「複数ブロック選択」チェック（エディタ直下の兄弟ブロック間を検出）は、同一 `<pre>` や `<blockquote>` 内の選択では `startBlock === endBlock` となりスキップ
- フォールスルーした先の `execCommand('insertText', false, '    ')` が選択範囲を削除して4スペースに置換（CLAUDE.md Section 19 の問題）
- `Shift+Tab` のハンドラはカーソル位置の1行のみを処理

## 対策

### 設計

Tab ハンドラのテーブルセルチェック直後（リスト項目チェックの前）に、コードブロック・引用ブロック検出を挿入。

```
Tab handler フロー:
1. テーブルセル → セル間移動 (既存)
2. ★NEW: コードブロック (`<pre>`) → indentLinesInContainer()
3. ★NEW: 引用ブロック (`<blockquote>`) → indentLinesInContainer()
4. リスト項目 (既存)
5. 複数ブロック (既存)
6. 単一ブロックフォールバック (既存)
```

### 実装

3つのヘルパー関数を `getCodePlainText()` 直後に追加:

1. **`getTextOffsetInContainer(container, node, offset)`** — DOM Selection 位置をコンテナ内プレーンテキストオフセットに変換。テキストノードの文字数と `<br>` を `\n` としてカウント。

2. **`textOffsetToDomPosition(container, textOffset)`** — プレーンテキストオフセットから DOM の `{node, offset}` ペアに逆変換。

3. **`indentLinesInContainer(container, isShiftTab)`** — 選択範囲のテキストオフセット取得 → `getCodePlainText()` で全文テキスト取得 → 行分割 → 選択範囲と重なる行を特定 → 各行の先頭にスペース追加/削除 → DOM を `textNode + <br>` で再構築 → 調整後のオフセットで選択範囲を復元。

オフセット調整アルゴリズムは元のテキスト上の行開始位置を事前に記録し、各行の変更量を `startAdjust` / `endAdjust` として蓄積する方式。

### 動作

| 操作 | コードブロック | 引用ブロック |
|---|---|---|
| 複数行選択 + Tab | 全選択行の先頭に4スペース追加 | 同左 |
| 複数行選択 + Shift+Tab | 全選択行から最大4スペース削除 | 同左 |
| 単一行 Tab | 4スペース挿入（既存動作維持） | 同左 |
| 単一行 Shift+Tab | 先頭スペース削除（既存動作維持） | 同左 |

### テスト

`test/specs/codeblock-blockquote-multiline-tab.spec.ts` に8テストケース追加:
- コードブロック: 複数行Tab、複数行Shift+Tab、部分スペースShift+Tab、単一行Tab回帰、単一行Shift+Tab回帰
- 引用ブロック: 複数行Tab、複数行Shift+Tab、Markdown出力でプレフィックス維持
