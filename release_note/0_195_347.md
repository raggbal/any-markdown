# v0.195.347 リリースノート

## HTMLペースト時のリスト項目間の空白行を除去

### 課題

外部HTML（Webページ、Google Docs等）をコピーしてエディタにペーストすると、リスト要素（バレット、数字、タスクリスト）の項目間に空白行が挿入されてしまう。

例：
```
- item1

- item2

- item3
```

期待される出力：
```
- item1
- item2
- item3
```

### 原因

外部HTMLでは `<li>` の中に `<p>` タグが含まれることが多い（例: `<ul><li><p>item1</p></li><li><p>item2</p></li></ul>`）。

Turndownライブラリのデフォルト `listItem` ルールは、`<p>` を含む `<li>` を "loose list" として扱い、項目間に空行（`\n\n`）を挿入するMarkdownを生成する。この空行入りMarkdownが `markdownToHtmlFragment()` で変換される際、リストが分割され、視覚的に空白行が表示される。

### 対策

#### 設計

1. **カスタムTurndown `compactListItem` ルール**: Turndownのデフォルト `listItem` ルールをオーバーライドし、常に "tight list"（空行なし）のMarkdownを生成する
2. **後処理セーフティネット**: Turndown変換後に正規表現でリスト項目間の残存空行を除去する

#### 実装

**`src/webview/editor.js`** のペーストハンドラ内Turndown設定に以下を追加：

1. `compactListItem` ルール（`filter: 'li'`）:
   - `content.replace(/^\n+/, '')` — 先頭改行を除去
   - `content.replace(/\n+$/, '')` — 末尾改行を除去（`\n` を残すとインデント置換で `\n    ` となり空行化する問題を回避）
   - `content.replace(/\n/gm, '\n    ')` — ネスト内容を4スペースインデント
   - ol/ul判定でプレフィックス（`- ` or `N. `）を付与
   - `node.nextSibling` があれば末尾に `\n` を追加

2. 後処理（Turndown変換直後）:
   - 正規表現 `/(^[ \t]*(?:[-*+]|\d+\.)\s+.*)\n{2,}([ \t]*(?:[-*+]|\d+\.)\s)/gm` でリスト項目間の空行を `\n` に置換
   - ループで収束するまで繰り返し

### テスト

新規テストファイル `test/specs/html-paste-list.spec.ts` に5ケース追加：
- バレットリスト（`<li><p>` 形式）— 空行なし確認
- バレットリスト（`<li>` 直接テキスト形式）— 空行なし確認
- 数字リスト（`<li><p>` 形式）— 空行なし確認
- タスクリスト — 空行なし確認
- ネストバレットリスト — 空行なし、インデント正常確認

全554テスト合格（既存テストへの回帰なし）。
