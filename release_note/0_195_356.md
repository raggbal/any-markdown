# v0.195.356 リリースノート

## リスト範囲選択 + Backspace で空バレットが残るバグ修正

### 課題

ネストされたリスト項目を範囲選択して Backspace を押すと、テキストは削除されるが空の `<li>` 要素（バレット）が残ってしまう。特にネストリストで高確率で再現。

**再現例:**

```
変換前:             変換後（バグ）:    変換後（期待）:
- a                 - (空)            - (空、カーソルここ)
  - b   ← 選択      - •(空バレット)
    - c ← 選択        - •(空バレット)
```

テキスト `a`, `b`, `c` は削除されるが、`b` と `c` の `<li>` コンテナが空のまま残存し、バレットだけが表示される。

### 原因

`editor.js` 5962-6068行の範囲選択 Backspace ハンドラが、**`range.startContainer` から見つけた最初の `<li>` だけを処理**し、選択範囲内の他の `<li>` を完全に無視していた。

1. `range.startContainer` → 親を辿って最初の `<li>`（startLi）のみ取得
2. `range.deleteContents()` がテキストを削除するが、`<li>` コンテナ自体は残る（DOM の `deleteContents` は部分的に含まれるノードのコンテナを削除しない）
3. startLi のみクリーンアップ（空なら `<br>` 追加）
4. **endLi やその間の `<li>` は放置** → 空バレットとして残存

### 対策

#### 設計

`deleteContents()` の前に選択範囲内の全 `<li>` を収集し、削除後に空になった `<li>` をクリーンアップする。

1. **削除前**: `range.endContainer` から `endLi` を取得し、startLi と endLi の間の全 `<li>` を DOM 順で収集
2. **削除後**: 収集した `<li>` のうち startLi 以外で空になったものを除去
3. 空 `<li>` にネストリストがある場合は、中身の `<li>` 子要素を親リストに昇格してから除去（v0.195.358で確定した方式）
4. 子要素のない空 `<ul>`/`<ol>` も除去
5. `isConnected` チェックで detached node への操作を防止

#### 実装

`src/webview/editor.js` の範囲選択 Backspace ハンドラ（5981行付近）に以下を追加:

```javascript
// 削除前に endLi と間の全 <li> を収集
let endLi = null;
let endNode = range.endContainer;
while (endNode && endNode !== editor) {
    if (endNode.nodeType === 1 && endNode.tagName.toLowerCase() === 'li') {
        endLi = endNode;
        break;
    }
    endNode = endNode.parentNode;
}

const affectedLis = [];
if (endLi && endLi !== liElement) {
    const allLis = Array.from(editor.querySelectorAll('li'));
    const startIdx = allLis.indexOf(liElement);
    const endIdx = allLis.indexOf(endLi);
    for (let i = Math.min(startIdx, endIdx) + 1; i <= Math.max(startIdx, endIdx); i++) {
        affectedLis.push(allLis[i]);
    }
}

// deleteContents() 後にクリーンアップ
for (const affectedLi of affectedLis) {
    if (!affectedLi.isConnected) continue;
    // 空判定 → ネストリスト子<li>を親リストに昇格 → 空<li>除去 → 空親リスト除去
    if (!hasContent) {
        const nestedLists = Array.from(affectedLi.querySelectorAll(':scope > ul, :scope > ol'));
        for (const nl of nestedLists) {
            while (nl.firstChild) {
                parentList.insertBefore(nl.firstChild, affectedLi);
            }
            nl.remove();
        }
        affectedLi.remove();
    }
}
```

#### テスト

`test/specs/backspace-list-range-selection.spec.ts` を新規作成（5テスト）:

1. ネストリスト3項目を全選択して Backspace → 空バレットが残らない
2. 同階層リスト2項目を範囲選択して Backspace → 空バレットが1つだけ残る
3. ネストリスト途中の2項目を範囲選択して Backspace → 選択外の項目は維持
4. 単一 `<li>` 内の部分テキスト選択 + Backspace → 既存動作が壊れない（回帰テスト）
5. ネストリストの上位2項目を範囲選択して Backspace → 下位の子リストが消えない

全5テスト合格。既存の `backspace-list.spec.ts` 全32件継続合格。
