# v0.195.327 - Shift+↑/↓による範囲選択が通常要素で効かない問題の修正

## 課題

Shift+ArrowUp / Shift+ArrowDown によるテキスト範囲選択が、以下の要素で動作しない:

| 要素 | Shift+矢印 | 状態 |
|---|---|---|
| 段落 | 動かない | NG |
| 見出し | 動かない | NG |
| リスト | 部分的（インデントが深いと途中抜け） | NG |
| 水平線付近 | 動かない | NG |
| テーブルセル内 | 動作する | OK（実装済み） |
| コードブロック内 | 動作する | OK（実装済み） |
| 引用ブロック内 | 動作する | OK（実装済み） |

## 原因

ArrowUp/ArrowDown のキーハンドラは3箇所に分かれている:

1. **テーブルセルハンドラ**（7508行付近）— `if (e.shiftKey) { return; }` あり
2. **コードブロック/引用ブロックハンドラ**（7620行付近）— `if (e.shiftKey) { return; }` あり
3. **侵入コード（invasion code）**（7799行付近）— **`e.shiftKey` チェックなし**

侵入コードは、通常要素（段落・見出し・リスト）の先頭行/最終行でArrowUp/ArrowDownを押した時に、隣接ブロック要素への移動を行うコード。このコードが `e.shiftKey` を確認せずに `e.preventDefault()` を呼び出すため、ブラウザネイティブの範囲選択動作が無効化されていた。

```
// 修正前の侵入コード（ArrowUp）
if (e.key === 'ArrowUp') {
    if (!isCursorAtFirstLine(currentElement)) return;
    // ← ここに e.shiftKey チェックがない
    let prev = currentElement.previousElementSibling;
    if (prev) {
        e.preventDefault();  // ← Shift+↑でもpreventDefaultされてしまう
        navigateToAdjacentElement(prev, 'up', false);
        return;
    }
}
```

## 対策

### 設計

テーブル・コードブロック/引用と同じパターンで、侵入コードの ArrowUp / ArrowDown 両方に `if (e.shiftKey) { return; }` ガードを追加する。Shiftキーが押されている場合はブラウザのデフォルト動作に委ねることで、ネイティブの範囲選択が正しく機能する。

### 実装（1ファイル）

| ファイル | 変更内容 |
|---|---|
| `editor.js` | 侵入コードの ArrowUp（7801行付近）と ArrowDown（7811行付近）に `if (e.shiftKey) { return; }` を追加 |

### 修正後のコード

```javascript
if (e.key === 'ArrowUp') {
    if (!isCursorAtFirstLine(currentElement)) return;

    // If Shift is pressed, let browser handle selection
    if (e.shiftKey) {
        return;
    }

    let prev = currentElement.previousElementSibling;
    if (prev) {
        e.preventDefault();
        navigateToAdjacentElement(prev, 'up', false);
        return;
    }
} else if (e.key === 'ArrowDown') {
    if (!isCursorAtLastLine(currentElement)) return;

    // If Shift is pressed, let browser handle selection
    if (e.shiftKey) {
        return;
    }

    let next = currentElement.nextElementSibling;
    if (next) {
        e.preventDefault();
        navigateToAdjacentElement(next, 'down', false);
        return;
    }
}
```

### テスト結果

- 既存テスト 519件 全パス（1件の失敗は `samples/b.md` 不在による既知の問題で無関係）
