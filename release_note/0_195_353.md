# v0.195.353 リリースノート

## Backspace時のネストliマージで子リストの行順序が崩れるバグ修正

### 課題

ネストされた最初の `<li>` (b) の先頭で Backspace を押すと、b のテキストは正しく親 li (a) に合流するが、**b の子リスト (c) が後続の兄弟 (d) の下に移動してしまう**バグが発生していた。

**再現例:**

```
変換前:          変換後（バグ）:   変換後（期待）:
- a              - ab             - ab
  - |b             - d              - c
    - c              - e              - d
  - d              - c                - e
    - e
```

バレット(ul)・数字(ol)・タスクリストの全種別と、それらの混在ケース（6パターン）で発生。

あわせて、**隣接テキストノードが normalize されていなかった**ため、マージ後の "a" + "b" が 2 つの別テキストノードとして残っていた（ユーザー視点では "ab" に見えるが DOM 上は分割されていた）。

### 原因

#### 1. 子リスト挿入位置の誤り（主原因）

**旧コード（OLD handler Case 1b、line ~6302）:**
```javascript
while (savedNestedList.firstChild) {
    existingNestedList.appendChild(savedNestedList.firstChild); // BUG: 末尾に追加
}
```

**旧コード（NEW handler handleNonEmptyLiStart、line ~8801）:**
```javascript
while (nl.firstChild) {
    existingNestedList.appendChild(nl.firstChild); // BUG: 末尾に追加
}
```

b は親リストの **最初の項目**なので、b の子 (c) は d より **前**に来なければならない。
`appendChild` は末尾に追加するため c が d の後ろに移動してしまっていた。

#### 2. テキストノード非正規化

b のテキスト "b" を parentLi に移動した後、`Node.normalize()` を呼ばなかったため、
"a" (元の textNode) と "b" (移動した textNode) が別ノードとして残っていた。

#### 3. タスクリスト項目の先頭スペース

タスクリスト項目の HTML は `<li><input type="checkbox"> b<ul>...</ul></li>` となっており、
checkbox の直後にスペースを含む textNode `" b"` がある。
マージ後に `normalize()` しても "a b"（スペースあり）になってしまっていた。

### 対策

#### 設計

「b は最初の項目なので c は d より先に来なければならない」という原則に基づき：

1. **同種リスト（ul+ul, ol+ol）**: `savedNestedList` / `nl` の子を、`existingNestedList` の **先頭**（`firstChild` の前）に `insertBefore` で挿入
2. **異種リスト（ul+ol 等）**: `savedNestedList` / `nl` 自体を `existingNestedList` の **前**に挿入（リスト種別を維持）
3. **normalize**: マージ後に `parentLi.normalize()` / `visualPrev.normalize()` を呼び、隣接テキストノードを結合
4. **タスクリスト先頭スペース除去**: 移動するテキストノードの先頭空白を `replace(/^\s+/, '')` で除去

#### 実装

`src/webview/editor.js` の 2 箇所を修正:

**OLD handler Case 1b（line ~6302-6321）:**
```javascript
if (savedNestedList) {
    const existingNestedList = parentLi.querySelector(':scope > ul, :scope > ol');
    if (existingNestedList) {
        if (savedNestedList.tagName === existingNestedList.tagName) {
            // 同種: 先頭に insertBefore
            const firstExistingChild = existingNestedList.firstChild;
            while (savedNestedList.firstChild) {
                existingNestedList.insertBefore(savedNestedList.firstChild, firstExistingChild);
            }
        } else {
            // 異種: savedNestedList ごと前に挿入
            existingNestedList.parentNode.insertBefore(savedNestedList, existingNestedList);
        }
    } else {
        parentLi.appendChild(savedNestedList);
    }
}
// ...カーソル設定後...
parentLi.normalize();
```

**NEW handler handleNonEmptyLiStart（line ~8792-8810）:**
```javascript
if (nestedLists.length > 0) {
    const existingNestedList = visualPrev.querySelector(':scope > ul, :scope > ol');
    if (existingNestedList) {
        for (const nl of nestedLists) {
            if (nl.tagName === existingNestedList.tagName) {
                const firstExistingChild = existingNestedList.firstChild;
                while (nl.firstChild) {
                    existingNestedList.insertBefore(nl.firstChild, firstExistingChild);
                }
            } else {
                existingNestedList.parentNode.insertBefore(nl, existingNestedList);
            }
        }
    } else {
        for (const nl of nestedLists) {
            visualPrev.appendChild(nl);
        }
    }
}
// ...カーソル設定後...
visualPrev.normalize();
```

**タスクリスト先頭スペース除去（両ハンドラ共通）:**
```javascript
// currentContent (old) / nodesToMove (new) の最初の textNode から先頭空白を除去
if (items.length > 0 && items[0].nodeType === 3) {
    items[0].textContent = items[0].textContent.replace(/^\s+/, '');
    if (!items[0].textContent) items.shift();
}
```

#### テスト

`test/specs/backspace-nested-li-children.spec.ts` を新規作成（14 テスト）:

**基本ケース:**
- ul 内 b に子 c、兄弟 d がある基本ケース
- c に子 c2 がある深ネストケース
- b が唯一の項目
- 後続兄弟が複数 (c, d, e)

**混在リスト（全 6 ペア）:**
- ul→ol, ol→ul, task→ul, ul→task, ol→task, task→ol

**b の子が別種:**
- b の子が ol、兄弟 d が同 ul

**round-trip 検証:**
- Backspace 後の Markdown で c が d より前に来ること

**回帰テスト:**
- b が子なし → 普通にマージ
- b が子なし、兄弟なし → 単純マージ

全 14 テスト合格。既存の `backspace-list.spec.ts`, `shift-tab-*.spec.ts` 全件継続合格。
