# v0.195.352 リリースノート

## Shift+Tab（トップレベルリスト項目→段落変換）時の行順序バグ修正

### 課題

トップレベルのリスト項目（`<ul>`/`<ol>`/タスクリスト）の中間にカーソルを置いてShift+Tabを押すと、その項目が段落に変換されるが、**段落がリストの末尾に移動してしまい行順序が崩れていた**。

**再現例（バレットリスト）:**

```
変換前:          変換後（バグ）:   変換後（期待）:
- a              - a              - a
- b  ← Shift+Tab - c              b
- c                b              - c
```

バレット(ul)・数字(ol)・タスクリストの全種別で発生。また単一行だけでなく、Shift+↑/↓で複数行を範囲選択してからShift+Tabを押した場合も同様のバグが発生した。

### 原因

`convertListItemToParagraph()` 関数が、常に段落を**親リスト全体の後ろ**に挿入していた。

```javascript
// 旧コード（問題箇所）
if (parentList.nextSibling) {
    parentList.parentNode.insertBefore(p, parentList.nextSibling);
} else {
    parentList.parentNode.appendChild(p);
}
li.remove();
if (parentList.children.length === 0) {
    parentList.remove();
}
```

`- a / - b / - c` の `b` を変換すると:
1. `parentList` には `a`, `c` が残る
2. 段落 `b` は `parentList`（`a, c`を含む）の後ろに挿入
3. 結果: `a c b`（bが末尾に来る）

### 対策

#### 設計

「リスト分割（split）」方式に変更。対象 `<li>` の位置でリストを3分割する:
- **前半**: 変換前の兄弟（元のリストに残す）
- **段落 p**: 変換後の段落
- **後半**: 変換後の兄弟（新リストに移す）

挿入順序:
1. 前半が0件 → 元リストを削除して段落を前リスト位置に挿入
2. 前半が1件以上 → 元リストの直後に段落を挿入
3. 段落の後に `<li>` 内のネストリスト（`nestedLists`）を挿入
4. ネストリストの後に後半を格納した新リストを挿入

#### 実装

`src/webview/editor.js` の `convertListItemToParagraph()` を修正:

```javascript
// 後続兄弟を収集・一時的に削除
var followingItems = [];
var sib = li.nextElementSibling;
while (sib) {
    followingItems.push(sib);
    sib = sib.nextElementSibling;
}
for (var j = 0; j < followingItems.length; j++) {
    followingItems[j].remove();
}

const p = document.createElement('p');
p.innerHTML = content.trim() || '<br>';
li.remove();

// 前半が空なら元リストを削除して段落をその位置に挿入
if (parentList.children.length === 0) {
    parentList.parentNode.insertBefore(p, parentList);
    parentList.remove();
} else {
    // 前半が残るなら段落はその直後
    if (parentList.nextSibling) {
        parentList.parentNode.insertBefore(p, parentList.nextSibling);
    } else {
        parentList.parentNode.appendChild(p);
    }
}

// nestedLists → followingItems の順で段落の後に挿入
var insertAfter = p;
for (var i = 0; i < nestedLists.length; i++) {
    // insertAfterの直後に挿入
    ...
    insertAfter = nestedLists[i];
}
if (followingItems.length > 0) {
    var newList = document.createElement(listTagName);
    for (var k = 0; k < followingItems.length; k++) {
        newList.appendChild(followingItems[k]);
    }
    // newListをinsertAfterの直後に挿入
}
```

#### テスト

`test/specs/shift-tab-toplevel-paragraph.spec.ts` を新規作成（22テスト）:

**単一行 Shift+Tab:**
- バレット先頭・中間・末尾の3位置
- 数字リスト中間
- タスクリスト中間
- 混在リスト全6ペア（ul+ol, ul+task, ol+ul, ol+task, task+ul, task+ol）

**複数行 Shift+Tab（Shift+↑/↓で範囲選択）:**
- バレット中間2項目・先頭2項目
- 数字リスト・タスクリスト中間
- 混在リスト4ペア（ul→ol, ol→task, task→ul, task中間→ul後続）

**round-trip検証:**
- Shift+Tab後のMarkdown出力が正しい行順序を持つことを確認

全22テスト合格。既存のShift+Tabテスト（`shift-tab-mixed-list-order.spec.ts`, `shift-tab-mixed-list-siblings.spec.ts`, `shift-tab-nested-children.spec.ts`）も全件継続合格。
