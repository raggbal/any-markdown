# v0.195.351 リリースノート

## HTMLペースト時のShikiコードブロック言語抽出

### 課題

code.claude.com等のShikiベースのシンタックスハイライトを使用するサイトからコードブロックを含むHTMLをCmd+Vで貼り付けると、コードブロックの言語タグが空になり `plaintext` 表示になっていた。

例: code.claude.comからコピーすると `<pre class="shiki" language="shellscript"><code language="shellscript">...` という構造のHTMLがクリップボードに入るが、Turndownのデフォルト`fencedCodeBlock`ルールは `class="language-xxx"` パターンしか認識しないため、言語情報が失われていた。

### 原因

2つの問題があった:

1. **言語属性の不一致**: Shikiは `language="xxx"` 属性を使用するが、Turndownは `class="language-xxx"` からしか言語を抽出しない
2. **`firstChild` 判定の脆弱性**: Turndownのデフォルト`fencedCodeBlock`フィルタは `node.firstChild.nodeName === 'CODE'` を要求するが、`<pre>` 内にインデント用のテキストノード（空白）がある場合、`firstChild` がテキストノードになりフィルタにマッチしない

### 対策

#### 設計

Web crawlerプロジェクトの `fencedCodeWithLang` ルール（`node.querySelector('code')` で `<code>` を検索する方式）を参考に、Turndownの`addRule`でカスタムルールを追加。

#### 実装

`src/webview/editor.js` のTurndownService設定に `fencedCodeWithLang` ルールを追加:
- **フィルタ**: `node.nodeName === 'PRE' && node.querySelector('code')` — `firstChild` ではなく`querySelector`で`<code>`を検索
- **言語抽出の優先順位**:
  1. `code.className` から `language-xxx` パターン
  2. `code` または `pre` の `language` 属性（Shiki対応）
  3. `pre` の `data-lang` 属性
- **言語クリーンアップ**: スペース以降を除去（`theme={null}` 等の非言語情報を除去）
- **非言語クラス除外**: `hljs`, `nohighlight`, `shiki` を言語名として使用しない

#### テスト

`test/specs/html-paste-shiki-codeblock.spec.ts` に3テスト追加:
- Shiki形式コードブロック（`language`属性）の変換
- Steps/Step div構造内のコードブロック変換
- `language`属性からの言語タグ抽出確認

全570テスト合格（既存の `perplexity-highlight-test` 1件は既知の失敗で今回と無関係）。
