# v0.195.350 リリースノート

## HTMLペースト時のリンク正規化

### 課題

外部HTMLをCmd+Vで貼り付けた際、`<a>`タグ内に`<div>`やその他のブロック要素が含まれていると、Turndownが複数行のマークダウンリンクを生成していた。

例: Claude Code Docsのようなサイトからコピーした場合:
```html
<a href="/docs/en/how-claude-code-works">
  <div>How Claude Code works</div>
</a>
```

変換結果:
```markdown
[

How Claude Code works

](/docs/en/how-claude-code-works)
```

### 原因

Turndownのデフォルトのリンク変換ルールは、`<a>`タグ内のcontentをそのまま使用する。`<a>`内に`<div>`等のブロック要素があると、contentに改行が含まれ、マークダウンリンク構文が複数行に展開される。

### 対策

#### 設計

Turndownの`addRule`で`normalizeLink`カスタムルールを追加。`<a>`タグのcontent内の改行・余分な空白を単一スペースに潰す。Web crawler側の`turndown.js`で先行して同じ修正を適用済みだったため、同じパターンをエディタのペースト処理にも適用。

#### 実装

`src/webview/editor.js` のTurndownService設定に`normalizeLink`ルールを追加:
- `content`の改行を空白に、連続空白を単一空白に正規化し、trim
- 空contentのリンクは除去
- `href`の括弧エスケープ (`(` → `\(`, `)` → `\)`)
- `title`属性のダブルクォートエスケープ

#### テスト

`test/specs/html-paste-link-normalize.spec.ts` に4テスト追加:
- ブロック要素を含む`<a>`タグの正規化
- ナビゲーションリンク（改行含む）の正規化
- 通常の単一行リンクの保持
- title属性付きリンクの処理
