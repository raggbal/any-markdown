# Release Note: v0.195.324

## 概要

異種混合リスト（ol/ul/タスクが兄弟として共存）でShift+Tabを実行すると、行順序がずれるバグを修正。

---

## 課題

### 再現手順

以下の状態で `c` にカーソルを置きShift+Tabを押す：

```
1. a
- [ ] b
  1. c   ← Shift+Tab
    1. d
  - e
```

### 期待される結果（行順序維持）

```
1. a
- [ ] b
- c       ← インデントが下がるだけ、行位置は同じ
  1. d
  - e
```

### 実際の結果（行順序がずれる）

```
1. a
- [ ] b
  - e     ← e が上に来てしまう
- c
  1. d
```

---

## 原因

### `outdentListItem()` が parentList の後の兄弟リストを収集しない

異種混合リストでは、同じ親 `<li>` の下に異なる型のリストが兄弟として並ぶ：

```html
<li>☐ b
  <ol>              ← parentList（c が入っている）
    <li>c
      <ol><li>d</li></ol>
    </li>
  </ol>
  <ul>              ← parentList の兄弟（e が入っている）
    <li>e</li>
  </ul>
</li>
```

`outdentListItem()` は `li.nextElementSibling` で**同じリスト内の弟**だけを `followingSiblings` として収集する。`e` は別の `<ul>` にいるため収集されず、`c` が抜けた後も `b` の子として残る。

```
collectの範囲:
  <ol>
    <li>c</li>     ← 対象
    <li>f</li>     ← ✓ followingSibling として収集される
  </ol>
  <ul>
    <li>e</li>     ← ✗ 別リストなので収集されない → 行順序ずれの原因
  </ul>
```

### 同種リストでは問題が起きない理由

バレットリストのみの場合、`c` と `e` は同じ `<ul>` 内に入るため、`nextElementSibling` で収集される。

---

## 対策

### 設計

`parentList` の後に続く兄弟リスト（`<ul>`/`<ol>`）を「trailing sibling lists」として収集し、outdent後の `li` の子として移動する。これにより、行順序が維持される。

```
修正前:
  c を outdent → e は b の下に残る → 行順序ずれ

修正後:
  c を outdent → e も c の下に移動 → 行順序維持
```

### 実装

```javascript
// parentList の後の兄弟リストを収集（parentList の前は対象外）
var trailingSiblingLists = [];
var nextOfParent = parentList.nextElementSibling;
while (nextOfParent) {
    var nextTag = nextOfParent.tagName ? nextOfParent.tagName.toLowerCase() : '';
    if (nextTag === 'ul' || nextTag === 'ol') {
        trailingSiblingLists.push(nextOfParent);
    }
    nextOfParent = nextOfParent.nextElementSibling;
}

// ... li を grandparentList に挿入 ...
// ... followingSiblings を処理 ...

// trailing sibling lists を li の子として移動（行順序維持）
for (var i = 0; i < trailingSiblingLists.length; i++) {
    li.appendChild(trailingSiblingLists[i]);
}
```

### 処理順序と行順序の対応

```
outdent 後の li の子:
  1. 既存の子リスト（例: d の <ol>）     ← もとから c の子
  2. followingSiblings（同リスト内の弟）   ← 既存ロジック
  3. trailing sibling lists（後続兄弟リスト） ← 新規追加

この順序が視覚的な行順序と一致する。
```

---

## テスト

### 新規テストファイル

[shift-tab-mixed-list-siblings.spec.ts](test/specs/shift-tab-mixed-list-siblings.spec.ts)（12件）

| テスト | 内容 |
| --- | --- |
| 報告バグ再現 | ol項目(c)のShift+Tabで後続ul(e)の行順序がずれない |
| 数字 > バレット | ol項目の後にul兄弟 |
| バレット > 数字 | ul項目の後にol兄弟 |
| タスク > バレット | タスク項目の後にul兄弟 |
| タスク > 数字 | タスク項目の後にol兄弟 |
| 数字 > タスク | ol項目の後にタスクul兄弟 |
| バレット > タスク | ul項目の後にタスクul兄弟 |
| 複数trailing | ol + ul + ol が全て行順序維持 |
| following + trailing | 同リスト内弟 + 後続兄弟リストの組み合わせ |
| 子リスト付き + trailing | 子リスト(d)もtrailing(e)も行順序維持 |
| 前の兄弟は移動しない | parentList の前の兄弟リストは対象外 |
| round-trip | Shift+Tab後のMarkdownで行順序が正しい |

### テスト結果

| テストスイート | 結果 |
| --- | --- |
| shift-tab-mixed-list-siblings (12件) | 全パス |
| shift-tab-nested-children (5件) | 全パス（v0.195.323の回帰なし） |
| 全体 (509件) | 504パス / 1失敗（既存・無関係）/ 4スキップ |

---

## 変更ファイル一覧

| ファイル | 変更内容 |
| --- | --- |
| `src/webview/editor.js` | `outdentListItem()`: trailing sibling lists 収集・移動ロジック追加 |
| `test/specs/shift-tab-mixed-list-siblings.spec.ts` | 新規テストファイル（12件） |
| `test/html/standalone-editor.html` | 自動再生成 |
| `package.json` | バージョン 0.195.323 → 0.195.324 |
