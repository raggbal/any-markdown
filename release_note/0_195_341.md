# v0.195.341 - 引用ブロックBackspace行分割修正 + コードブロック先頭Backspace防止

## 修正1: 引用ブロック先頭Backspaceで各行が個別段落にならない

### 課題

複数行の引用ブロック（`> a` / `> b` / `> c`）の先頭でBackspaceを押すと、blockquoteは解除されるが、各行が個別の`<p>`に変換されず、`<p>a\nb\nc</p>`と1段落にまとまってしまう。

### 原因

`markdownToHtmlFragment()`の`renderBlockquote()`関数は各行を`\n`テキストノードで結合してblockquote内に格納する（editor.js:1857-1865）。一方、Backspaceハンドラの行分割ロジック（editor.js:9918）は`<br>`要素のみを行区切りとして認識しており、`\n`テキストノードによる行分割が未対応だった。

Enter（`insertLineBreak`）で追加された行は`<br>`で区切られるため分割されるが、初期レンダリングからの`\n`テキストは1行として扱われていた。

### 対策

#### 設計

テキストノード内の`\n`も`<br>`と同様に行区切りとして認識し、個別のDocumentFragmentに分割する。

#### 実装

blockquoteのBackspaceハンドラ内のchildNodes走査ループに、テキストノード内の`\n`分割処理を追加:

```javascript
} else if (node.nodeType === 3 && node.textContent.includes('\n')) {
    const parts = node.textContent.split('\n');
    for (let i = 0; i < parts.length; i++) {
        if (i > 0) {
            lines.push(currentFragment);
            currentFragment = document.createDocumentFragment();
        }
        if (parts[i] !== '') {
            currentFragment.appendChild(document.createTextNode(parts[i]));
        }
    }
}
```

---

## 修正2: コードブロック編集モード先頭でBackspaceが上の要素を削除する

### 課題

内容のあるコードブロックの先頭行先頭でBackspaceを押すと、上の要素（段落やコードブロック）が削除される。空コードブロックのときだけ段落に変換されるのが正しいが、非空でも上の要素に影響が出ていた。

### 原因

Backspaceハンドラのコードブロック処理（editor.js:9847-9865）は、空コードブロックの場合のみ`preventDefault()`して段落に変換していた。非空の場合はフォールスルーし、ブラウザのデフォルトBackspace動作が実行されるため、`<code>`の先頭でBackspaceを押すと前の要素とのマージが発生する可能性があった。

### 対策

#### 設計

非空コードブロックでカーソルが`<code>`要素の先頭にいる場合、`preventDefault()`して何もしない。カーソルが途中にある場合はブラウザのデフォルト動作（文字削除）を許可。

#### 実装

空チェックの後に、カーソル位置チェックを追加:

```javascript
if (codeElement) {
    const contentRange = document.createRange();
    contentRange.selectNodeContents(codeElement);
    contentRange.setEnd(range.startContainer, range.startOffset);
    const textBeforeCursor = contentRange.toString();
    if (textBeforeCursor.length === 0) {
        e.preventDefault();
        return;
    }
}
```

blockquoteのBackspaceハンドラと同じRange-based方式でカーソル位置を判定。

---

## テスト

`test/specs/blockquote-codeblock-backspace-fix.spec.ts` に6テスト追加:
- 引用ブロック: 3行/2行/1行の引用で先頭Backspace → 各行が個別段落に変換
- コードブロック: 内容あり先頭Backspace → 上の要素が消えない、連続コードブロック → 上が消えない、空コードブロック → 段落変換（既存動作維持）

全549テスト + 新規6テスト = 555テストパス、回帰なし。
