# v0.195.326 - Cmd+Z / Cmd+Shift+Z undo/redo キーボードショートカット修正

## 課題

Undo/Redoのツールバーボタンは正しく動作するが、Cmd+Z / Cmd+Shift+Z キーボードショートカットでは1回目が効かず、2回目で初めて反応する。

## 原因

VSCode Webview内でCmd+Zを押すと、2つのundoが同時に競合していた:

1. **VSCode本体のundo**: `CustomTextEditorProvider` のTextDocumentレベルでundoを実行 → `onDidChangeTextDocument` 経由でWebviewに`update`メッセージを送信
2. **Webview内のカスタムundoManager**: HTMLスナップショットを復元

### 競合のメカニズム

```
Cmd+Z キー入力
│
├─► 【VSCode本体】Cmd+Zをインターセプト
│   └─► document.undo() を実行
│       └─► TextDocument の内容が前のeditメッセージの状態に巻き戻される
│           └─► onDidChangeTextDocument が発火
│               └─► Webviewに 'update' メッセージを送信
│                   └─► カスタムundoManagerの結果が上書きされる
│
└─► 【Webview内】keydownイベント
    └─► undoManager.undo() を実行（正しい結果）
        └─► しかしVSCodeからのupdateメッセージで上書きされる
```

- **1回目のCmd+Z**: カスタムundoManagerが正しく復元するが、直後にVSCode本体からの`update`メッセージが到着し上書き
- **2回目のCmd+Z**: VSCode側のundoスタックが消費済み → カスタムundoManagerの結果が維持される

## 対策

### 設計

VSCodeのキーバインドシステムでCmd+Z / Cmd+Shift+Z / Cmd+Yを当エディタ専用コマンドにオーバーライドし、VSCode本体のundo/redoを完全にバイパスする。

```
Cmd+Z キー入力（修正後）
│
├─► 【VSCode】keybinding が any-markdown.undo にマッチ
│   └─► VSCode本体のundoは実行されない
│   └─► provider.sendUndo() → Webviewに 'performUndo' メッセージ
│       └─► undoManager.undo() が正しく実行される
```

### 実装（4ファイル）

| ファイル | 変更内容 |
| --- | --- |
| `package.json` | `any-markdown.undo`/`redo`コマンド定義。`activeCustomEditorId == 'any-markdown.editor'`条件でCmd+Z/Cmd+Shift+Z/Cmd+Yのキーバインドをオーバーライド |
| `extension.ts` | コマンド登録 → `provider.sendUndo()`/`sendRedo()`呼び出し |
| `editorProvider.ts` | `activeWebviewPanel`追跡（`onDidChangeViewState`/`onDidDispose`）。`sendUndo()`/`sendRedo()`で`performUndo`/`performRedo`メッセージをWebviewに送信 |
| `editor.js` | `performUndo`/`performRedo`メッセージハンドラ追加 → `undoManager.undo()`/`redo()`を呼び出し |

### 既存コードとの共存

- Webview内のcaptureフェーズの`preventDefault()`（ブラウザネイティブundo無効化）とdocument keydownハンドラのundo/redoコードはそのまま残す（スタンドアロンテスト環境での動作保証のため）


修正完了です。

**原因**: [editor.js:10787-10790](vscode-webview://1b3547eedeumh1qb55cbq2qjeufikeumoihb62ni2fvvkfh4n5n9/src/webview/editor.js#L10787-L10790) のスナップショット保存条件で、修飾キー（`Meta`, `Control`, `Shift`, `Alt`）が除外されていなかった。

Cmd キーを押しただけで `e.metaKey` が `true` になり、`e.key === 'Meta'` は除外リスト（`s`, `f`, `z` 等）に含まれていないため、`saveSnapshot()` が実行 → `redoStack.length = 0`（line 407）でredo スタックがクリアされていました。

**修正**: 修飾キー単体（`Meta`, `Control`, `Shift`, `Alt`）をスナップショット保存の除外リストに追加しました。
