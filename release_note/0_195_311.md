# Release Note: v0.195.309〜v0.195.311

## 概要

タスクリストのチェックボックス対応（v0.195.300〜）の後続として、リスト操作に関する3つの機能追加・修正を行った。

1. **タスクリストのTab/Shift+TabインデントのCSS修正**（v0.195.309）
2. **リスト種類の相互変換機能**（v0.195.310）
3. **異種リスト兄弟の表示・インデント修正**（v0.195.311）

---

## 1. タスクリストのTab/Shift+TabインデントのCSS修正（v0.195.309）

### 問題

タスクリスト項目でTabを押してもインデントが**視覚的に反映されない**。Markdownは正しく更新されるが、画面上の表示が変わらない。

### 原因

2つの独立した問題が同時に存在していた。

#### 原因A: selectionchangeハンドラの干渉

チェックボックスの前にカーソルが入らないようにする `selectionchange` ハンドラが、Tab/Shift+Tab処理中のDOM操作と干渉していた。

```javascript
// 問題のコード（削除済み）
document.addEventListener('selectionchange', function() {
    // チェックボックスの前にカーソルがあったら後ろに移動
    // → Tab処理中のDOM操作でも発火し、カーソル位置がリセットされる
});
```

#### 原因B: CSSの `margin-left: -2em` が全階層に適用

```css
/* Before: 全タスクリスト項目に適用 → ネストのインデントが相殺される */
.editor li:has(> input[type="checkbox"]) {
    list-style: none;
    margin-left: -2em;
}
```

ネストされたタスクリスト項目にも `-2em` が適用されるため、`padding-left` による視覚的なインデントが打ち消されていた。

### 修正

#### 修正A: selectionchangeハンドラを完全削除

`selectionchange` + `suppressCheckboxGuard` フラグ + `pointerdown` タイムスタンプ方式を全て撤去。

#### 修正B: CSSルールを分離

```css
/* After: list-styleは全階層、margin-leftはトップレベルのみ */
.editor li:has(> input[type="checkbox"]) {
    list-style: none;
}
.editor > ul > li:has(> input[type="checkbox"]) {
    margin-left: -2em;
}
```

### 修正箇所

| ファイル | 箇所 | 変更 |
|---|---|---|
| `editor.js` | selectionchangeハンドラ（旧3584-3610行付近） | 全削除 |
| `editor.js` | Tabハンドラ内の `suppressCheckboxGuard` 参照（2箇所） | 全削除 |
| `styles.css` | `.editor li:has(...)` ルール | トップレベル限定に分離 |

---

## 2. リスト種類の相互変換機能（v0.195.310）

### 機能概要

リスト項目内の行先頭でMarkdownパターンを入力 + Space で、リスト種類を相互変換できる新機能。

### 変換マトリクス

| 入力パターン | 変換先 | 例 |
|---|---|---|
| `- ` / `* ` / `+ ` + Space | バレットリスト（ul） | `1. - テスト` → バレットに変換 |
| `[ ] ` / `[x] ` + Space | タスクリスト（ul + checkbox） | `- [ ] テスト` → タスクに変換 |
| `1. ` + Space | 順序付きリスト（ol） | `- 1. テスト` → 数字に変換 |

### 対応する変換方向（全6方向）

```
バレット (ul) ←→ 順序付き (ol)
バレット (ul) ←→ タスク (ul + checkbox)
順序付き (ol) ←→ タスク (ul + checkbox)
```

### 既にそのリスト種類の場合

同じ種類への変換は無視される（例：バレットリスト内で `- ` + Space → 何もしない）。

### 実装の主要コンポーネント

#### 2-1. パターン認識（checkBlockPatterns内 li ブロック）

**ファイル**: `editor.js` 3695〜3853行

リスト項目内のテキストを取得し、3つのパターンに対してマッチング。

```javascript
// liの直接テキストのみ取得（ネストリストは除外）
let liDirectText = '';
for (const child of liNode.childNodes) {
    if (child.nodeType === 3) {
        liDirectText += child.textContent;
    } else if (child.nodeType === 1) {
        const tag = child.tagName.toLowerCase();
        if (tag !== 'ul' && tag !== 'ol') {
            liDirectText += child.textContent;
        }
    }
}
```

**ポイント**: `<input type="checkbox">` の `textContent` は空文字なので、タスクリスト項目でもチェックボックスのテキストは含まれない。つまり `□|テキスト` でも `|□テキスト` でも同じ `liDirectText` が得られる。

#### 2-2. 変換処理

各パターンマッチ後の処理：

1. ネストリストを `cloneNode(true)` で退避
2. `liNode.innerHTML = ''` でクリア
3. 新しいコンテンツを構築（タスクの場合はcheckbox追加）
4. ネストリストを復元
5. 必要に応じて `changeParentListType()` で親リストのタグを変更
6. カーソルをテキスト先頭に配置

#### 2-3. changeParentListType関数

**ファイル**: `editor.js` 9744〜9809行

親リストのHTMLタグ（ul↔ol）を変更する関数。

**単独子の場合**: 親タグをそのまま置換

```
<ol>          →    <ul>
  <li>a</li>        <li>a</li>
</ol>              </ul>
```

**複数兄弟の場合**: before/target/after に3分割

```
<ol>               <ol>
  <li>a</li>  →     <li>a</li>
  <li>b</li>       </ol>
  <li>c</li>       <ul>
</ol>                <li>b</li>    ← 変換対象
                   </ul>
                   <ol>
                     <li>c</li>
                   </ol>
```

分割後、隣接する互換リストは自動マージされる。

#### 2-4. areListsCompatible関数

リストのマージ可否を判定。

| リストA | リストB | マージ可否 |
|---|---|---|
| 通常ul | 通常ul | ○ |
| タスクul | タスクul | ○ |
| 通常ul | タスクul | ✕ |
| ol | ol | ○ |
| ul | ol | ✕ |

```javascript
function areListsCompatible(a, b) {
    if (a.tagName !== b.tagName) return false;
    if (a.tagName.toLowerCase() === 'ul') {
        // 通常ulとタスクulは非互換
        var aHasCheckbox = a.querySelector(':scope > li > input[type="checkbox"]') !== null;
        var bHasCheckbox = b.querySelector(':scope > li > input[type="checkbox"]') !== null;
        return aHasCheckbox === bHasCheckbox;
    }
    return true;
}
```

---

## 3. 異種リスト兄弟の表示・インデント修正（v0.195.311）

### 問題(A): Markdown→HTML変換でリストタイプが統一される

```markdown
- a
1. b
```

このMarkdownを表示すると、`1. b` もバレットとして表示される（兄のタイプで全統一される）。

### 原因(A)

`markdownToHtmlFragment` のリスト処理で、同レベルに新しいリスト項目を追加する際、リストタイプ（ul/ol）の変化をチェックしていなかった。

```javascript
// Before: タイプが変わっても同じリスト内に追加
} else {
    // Same level - just add another item
    html += '</li><li>' + parsed.html;
}
```

### 修正(A)

**ファイル**: `editor.js` 1920〜1937行

同レベルおよびインデント戻り時に、リストタイプの変化を検出。タイプが変わった場合は現在のリストを全て閉じて新しいリストを開始する。

```javascript
// After: タイプ変化を検出して別リストとして分離
} else {
    if (listStack[listStack.length - 1].type !== parsed.listType) {
        // Close current list and start new one of different type
        while (listStack.length > 0) {
            html += '</li></' + listStack.pop().type + '>';
        }
        html += '<' + parsed.listType + '><li>' + parsed.html;
        listStack.push({ type: parsed.listType, indent: indentLevel });
    } else {
        html += '</li><li>' + parsed.html;
    }
}
```

**結果**:

```markdown
- a
1. b
```
↓
```html
<ul><li>a</li></ul>
<ol><li>b</li></ol>
```

### 問題(B): 異種リスト兄弟でTabインデントが効かない

修正(A)により `<ul>` と `<ol>` が別DOM要素になったため、`indentListItem` が前の兄弟要素（同リスト内）を見つけられず、Tabインデントが機能しなくなった。

### 修正(B)

**ファイル**: `editor.js` 9869〜9894行

`indentListItem` にクロスリスト境界インデント機能を追加。同リスト内に前の兄弟がない場合、親リストの前にある隣接リスト要素の最後の `<li>` を探し、そこにネストする。

```javascript
// 同リスト内に前の兄弟がない場合
const parentList = li.parentNode;
const prevList = parentList ? parentList.previousElementSibling : null;
if (prevList && (prevList.tagName === 'ul' || prevList.tagName === 'ol')) {
    const lastLiOfPrev = prevList.lastElementChild;
    if (lastLiOfPrev && lastLiOfPrev.tagName === 'li') {
        // 前のリストの最後のliにネスト
        let nestedList = lastLiOfPrev.querySelector(':scope > ul, :scope > ol');
        if (!nestedList) {
            nestedList = document.createElement(currentListTag);
            lastLiOfPrev.appendChild(nestedList);
        }
        nestedList.appendChild(li);
        if (parentList.children.length === 0) parentList.remove();
    }
}
```

**結果**:

```
Before Tab:              After Tab:
<ul>                     <ul>
  <li>a</li>               <li>a
</ul>                        <ol><li>b</li></ol>
<ol>                       </li>
  <li>b</li>             </ul>
</ol>
```

Markdownでは：
```
- a                      - a
1. b                       1. b
```

---

## アーキテクチャ上の考慮事項

### HTMLの制約とリスト管理

HTMLの仕様上、`<ul>`（バレット）と `<ol>`（数字）は異なるDOM要素であり、1つのリスト要素内にバレットと数字を混在させることはできない。

そのため：
- **Markdown→HTML変換**: 異種リスト項目が隣接する場合、別々のリスト要素として分離
- **Tabインデント**: リスト境界を越えてネストできるよう拡張
- **HTML→Markdown変換**: 既存の `mdProcessNode` が各リスト要素を独立して処理するため、変更不要

### タスクリストの扱い

タスクリスト（`- [ ]`）は HTMLの `<ul>` + `<input type="checkbox">` で表現される。通常の `<ul>` との違いは li 内のチェックボックスの有無のみ。

- **マージ判定**: 通常ulとタスクulは非互換（マージしない）
- **HTML→Markdown**: li単位でチェックボックスの有無を見て `- [ ]` / `- ` を出力

---

## 修正箇所一覧

| バージョン | ファイル | 箇所 | 変更内容 |
|---|---|---|---|
| v0.195.309 | `editor.js` | selectionchangeハンドラ | 全削除 |
| v0.195.309 | `editor.js` | Tabハンドラ（2箇所） | `suppressCheckboxGuard` 参照を削除 |
| v0.195.309 | `styles.css` | タスクリストCSS | `margin-left: -2em` をトップレベル限定に分離 |
| v0.195.310 | `editor.js` | `checkBlockPatterns` li ブロック（3695-3853行） | 3パターンの相互変換を実装 |
| v0.195.310 | `editor.js` | 新規関数（9744-9855行） | `changeParentListType`, `areListsCompatible`, `mergeAdjacentLists` |
| v0.195.311 | `editor.js` | `markdownToHtmlFragment` リスト処理（1920-1937行） | リストタイプ変化検出を追加 |
| v0.195.311 | `editor.js` | `indentListItem`（9869-9894行） | クロスリスト境界インデントを追加 |

---

## テスト結果

- **449 passed** / 0 regressions
- 1 failed: `roundtrip.spec.ts` の `b.md` ファイル欠損（既存問題、今回の修正と無関係）
- 4 skipped
