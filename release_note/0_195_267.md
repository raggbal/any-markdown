# Release Note: v0.195.261 → v0.195.267

## Cmd+L でチャット連携（選択範囲をTextEditorで開く + クリップボードコピー）

---

## 概要

Webviewエディタでテキストを範囲選択し Cmd+L（Ctrl+L）を押すと、元のMarkdownファイルをVS CodeのTextEditorで開き、対応する行を選択状態にする。同時に選択範囲のMarkdownテキストをクリップボードにコピーする。

ユーザーはその後、TextEditor上で再度 Cmd+L を押すことで、VS Code / Cursor / Kiro 等のAIチャットに選択範囲を送信できる。

---

## 機能詳細

### 基本フロー

1. Webviewエディタでテキストを範囲選択
2. Cmd+L（Ctrl+L）を押す
3. TextEditorが開き、対応するMarkdown行が選択状態で表示
4. 選択範囲のMarkdownがクリップボードにコピーされる
5. ユーザーがTextEditor上で再度 Cmd+L を押してAIチャットに送信

### 精密な行選択

ブロック要素全体ではなく、選択した要素に対応する正確な行のみがTextEditorで選択される。

| 要素 | 動作 |
| --- | --- |
| 段落・見出し | 対応する行を選択 |
| リスト項目（`<li>`） | 選択した項目の行のみ（ネストリスト含む） |
| テーブル行（`<tr>`） | 選択したセルの行のみ |
| コードブロック・引用 | ブロック全体を選択 |

#### 例: リスト内の部分選択

```markdown
- 順序なしリスト1
- 順序なしリスト2      ← 選択開始
  - ネストリスト
  - ネストリスト2      ← 選択終了
```

従来: リスト全体（4行すべて）が選択されていた
修正後: 行1〜3のみが正確に選択される

#### 例: テーブル内の部分選択

```markdown
| 項目 | 値 | 備考 |
| --- | --- | --- |
| OS | Windows | CRLF |    ← 選択したセルの行のみ
| OS | Mac | LF |
| OS | Linux | LF |
```

従来: テーブル全体（5行すべて）が選択されていた
修正後: 選択したセルの行のみが選択される

---

## 実装詳細

### 行番号計算のアルゴリズム

DOM上の選択位置からMarkdownファイルの行番号を算出する。

#### startLine の計算

```
startLine = (選択開始ブロックより前の全ブロックのMarkdown行数)
           + (ブロック内での選択開始要素のオフセット)
```

#### endLine の計算

```
endLine = (選択終了ブロックより前の全ブロックのMarkdown行数)
         + (ブロック内での選択終了要素のオフセット)
         + (選択終了要素の行数) - 1
```

### リスト内の行オフセット計算

DOMツリーを再帰的に走査し、各 `<li>` を1行としてカウント。ネストリストも正しく追跡。

```javascript
function getListLineOffset(listEl, targetLi) {
    // DOM走査でtargetLi以前のli数をカウント
    // ネスト構造: 親liのcontains(targetLi)で分岐
    //   - targetLiの祖先li → 1行カウント + 子リストに再帰
    //   - 無関係のli → 1行 + 全子孫をカウント
}
```

### テーブル内の行オフセット計算

```javascript
function getTableLineOffset(tableEl, targetTr) {
    // Row 0 (ヘッダー) → markdown line 0
    // Row N (N≥1)       → markdown line N+1 (セパレータ行の分)
}
```

### ベースライン計算の2関数

| 関数 | 用途 | 例: `"# 見出し\n\n"` |
| --- | --- | --- |
| `countLinesTotal(md)` | ブロック開始行の算出（空行含む） | → **2** |
| `countContentLines(md)` | ブロック内の最終行算出（空行除外） | → **1** |

`countLinesTotal` はブロック間セパレータ（`\n\n`）を含めてカウントするため、後続ブロックの開始行が正確に算出される。

### selectedMarkdown の生成

全ドキュメントのMarkdownを生成し、startLine〜endLine でスライス。部分変換の不整合を回避。

```javascript
var fullMd = htmlToMarkdown();
var fullLines = fullMd.split('\n');
var mdSelected = fullLines.slice(startLine, endLine + 1).join('\n').trim();
```

---

## 変更ファイル

| ファイル | 変更内容 |
| --- | --- |
| `src/webview/editor.js` | Cmd+L ショートカットハンドラ追加（精密行番号計算 + selectedMarkdown送信） |
| `src/editorProvider.ts` | `sendToChat` メッセージハンドラ追加（TextEditor表示 + 行選択 + クリップボードコピー） |

---

## メッセージフロー

```
[Webview]                              [Extension Host]
    │                                        │
    │ Cmd+L pressed                          │
    │ ├ DOM選択範囲を取得                     │
    │ ├ startLine/endLine を計算              │
    │ ├ selectedMarkdown を生成               │
    │                                        │
    │  sendToChat message                    │
    │  (startLine, endLine, selectedMarkdown)│
    │ ──────────────────────────────────────►│
    │                                        │ ├ TextEditorでファイルを開く
    │                                        │ ├ editor.selection を設定
    │                                        │ ├ revealRange で画面内に表示
    │                                        │ └ clipboard.writeText でコピー
```

---

## 設計判断

### チャット自動起動を見送った理由

| 方式 | 問題点 |
| --- | --- |
| `workbench.action.chat.open` | VS Codeでは動作するが、Cursor / Kiro では動作しない |
| キーストローク送信 | VS Code Extension APIでは不可能 |
| IDE固有コマンドID | Cursor (`aichat.newchataction`) / Kiro のIDは非公開・変更される可能性 |

**結論**: TextEditorで選択状態にするところまでを機能範囲とし、チャットへの送信はユーザーが手動で Cmd+L を押す方式を採用。これによりIDE非依存で動作する。

---

## バージョン履歴

| バージョン | 変更内容 |
| --- | --- |
| v0.195.262 | 初期実装（テキストマッチングで行特定） |
| v0.195.263 | DOM位置ベースの行番号計算に変更（テキストマッチングの不正確さを解消） |
| v0.195.264 | `workbench.action.chat.open` を削除（IDE互換性のため） |
| v0.195.265 | クリップボードコピー機能を追加 |
| v0.195.266 | `<li>` / `<tr>` レベルの精密行選択を実装 |
| v0.195.267 | ベースライン計算のオフバイワン修正（ブロック間空行の正確なカウント） |
