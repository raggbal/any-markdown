# Release Note: v0.195.315〜v0.195.319

## 概要

リスト操作とブラウザ互換性に関する4つの修正・機能追加を行った。

1. **`position: absolute` 問題の方針転換**（v0.195.314で発見 → v0.195.315で修正方針確定）
2. **ツールバーボタンの修正**（v0.195.315）
3. **`<div>` 生成問題の根本対策**（v0.195.316）
4. **異種ネストリストのBackspace合流**（v0.195.317〜319）
5. **ツールバー/ショートカットのリスト種類変換の改善**（v0.195.317〜319）

---

## 1. ツールバーボタンの修正（v0.195.315）

### 問題

ツールバーボタンをクリックすると、エディタの選択範囲（Selection）が失われ、ボタン操作が意図した位置に反映されない。

### 原因

ツールバーの `<button>` をクリックすると、ブラウザがボタンにフォーカスを移し、エディタの Selection が消失する。`editor.focus()` で戻しても、Selection の復元が保証されない。

### 修正内容

- `mousedown` イベントでツールバーボタンクリック前の Selection を保存
- `click` イベントで `editor.focus()` 後に保存した Selection を復元

### ツールバーのリスト系ボタン改修

従来のリスト系ボタン（ul / ol / task）は `execCommand` や単純な要素作成を使っていたが、以下の問題があった：
- 既存リスト内でボタンを押してもリスト種類の変換ができない
- タスクリストボタンが既存のテキストを無視して新規リストを作成していた

修正後は `convertListToType()` を優先的に呼び出し、カーソルがリスト内にある場合はリスト種類の変換を行う。リスト外の場合のみ新規リスト作成にフォールバックする。

### コードブロックボタン改修

従来のコードブロックボタンは `contenteditable="true"` の `<pre>` を直接作成していたが、描画モード/編集モードの管理体系に合っていなかった。

修正後は `data-lang`、`data-mode="display"` を設定し、`setupCodeBlockUI()` → `enterEditMode()` を呼び出すことで、正しいUIとモード管理を行う。

---

## 2. `<div>` 生成問題の根本対策（v0.195.316）

### 問題

テーブルの後などで Enter を押すと `<div>` が生成され、以降 `<div>` が連鎖的に増殖する。`<div>` 内では `tag === 'p'` チェックが通らないため、HR変換（`---`）やテーブルパターン変換が効かなくなる。

### 原因

Chromium の `contenteditable` では、`defaultParagraphSeparator` 未設定の場合、Enter キーでの新規ブロック生成のデフォルトが `<div>`。通常はカスタム Enter ハンドラが `e.preventDefault()` して `<p>` を明示的に作るので問題にならないが、テーブル直後などでハンドラがフォールスルーするとブラウザのデフォルト動作で `<div>` が生成される。

### 修正内容（3点）

| 修正 | 目的 |
| --- | --- |
| `document.execCommand('defaultParagraphSeparator', false, 'p')` | ブラウザのデフォルト動作で `<p>` を生成させる（初期化時に実行） |
| `input` イベントでの `<div>` → `<p>` 正規化 | 万が一入り込んだ `<div>` を即座に修正（カーソル位置保持付き） |
| HR・テーブルのパターンに `tag === 'div'` 追加 | `<div>` 内でもパターンが効くように（防御的措置） |

### `<div>` → `<p>` 正規化の詳細

- `editor` 直下の `<div>` のうち、クラスなし（`.mermaid-wrapper`、`.math-wrapper`、`.find-replace-container` を除外）のものを `<p>` に置換
- カーソルが変換対象の `<div>` 内にある場合、Range を保存・復元して位置を維持

---

## 3. 異種ネストリストのBackspace合流（v0.195.317〜319）

### 問題

異なる種類のリスト（ol / ul）がネストされている場合に、ネストリストの先頭項目で Backspace を押すと、視覚的に一つ上の行ではなく親 `<li>` に合流してしまう。

### 例

```
1. item1
   - nested-a   ← ここで Backspace
   - nested-b
```

従来は `nested-a` が親の `<li>item1` に合流しようとしたが、DOM構造上は `<ol>` と `<ul>` が兄弟として並んでおり、視覚的に一つ上の行は `item1`（`<ol>` の最後の `<li>`）。

### 修正内容

**Case 1a（新規追加）**: ネストリストの先頭 `<li>` で Backspace を押した時、同じ親 `<li>` 内に前の兄弟リストが存在する場合、その兄弟リストの最後の `<li>`（最深のネストまで辿る）に合流する。

- 兄弟リストの最深の最後の `<li>` を探索
- 末尾の `<br>` を除去
- カーソル位置を保存
- 現在の `<li>` の内容（ネストリスト除く）をターゲット `<li>` に移動
- ネストリストがあればターゲット `<li>` に移動
- 空になったリストを削除

### タスクリストの `isAtBeginning` 判定修正

タスクリストの `<li>` ではチェックボックス（`<input>`）が先頭にあるため、カーソルの `startContainer` が `<li>` 自体で `startOffset` が 1（チェックボックスの後）の場合も「先頭にいる」と判定する必要があった。

---

## 4. ツールバー/ショートカットのリスト種類変換の改善（v0.195.317〜319）

### 問題

`convertListToType()` 関数が、ネストリストを持つ項目を変換する際にネストリストを失っていた。また、ul ↔ ol 変換時にリスト全体を変換してしまい、選択した項目のみの部分変換ができなかった。

### 修正内容

#### `convertLiToType()` ヘルパー関数の新設

個々の `<li>` 要素の変換を担当する関数を分離。チェックボックスの追加/削除を行いつつ、ネストリスト含む全子要素を保持する。

#### `convertListToType()` の改善

- **CASE A（同じ親タグ: ul ↔ task）**: `<li>` 要素をインプレースで変換（チェックボックスの追加/削除のみ）
- **CASE B（異なる親タグ: ul/task ↔ ol）**: リストを分割して変換（変換対象の前後を元の型で維持）

ショートカットキー（Ctrl+Shift+U/O/X）も同様に `convertListToType()` を優先的に呼び出すように変更。

---

## 新規テストファイル

| ファイル | テスト内容 |
| --- | --- |
| `backspace-mixed-nested-list.spec.ts` | 異種ネストリストでのBackspace合流テスト |
| `toolbar-list-conversion.spec.ts` | ツールバー/ショートカットによるリスト種類変換テスト |
